<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --system-font: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --background-color: #ffffff;
            --text-color: #202123;
            --primary-accent: #1a1a1a;
            --sidebar-bg: #f9f9f9;
            --border-color: #e5e5e5;
            --user-msg-bg: #f0f2f5;
            --sidebar-width-expanded: 280px;
            --sidebar-width-collapsed: 80px;
            --code-bg: #f0f2f5;
            --code-text-color: #383a42;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        html { scroll-behavior: smooth; }
        body, html {
            margin: 0; padding: 0; font-family: var(--system-font); height: 100%; width: 100%; overflow: hidden; background-color: var(--background-color); color: var(--text-color);
            -webkit-font-smoothing: antialiased; font-size: 16px;
        }
        body.is-dragging { user-select: none; -webkit-user-select: none; }
        body.is-dragging #chat-messages { overflow-y: hidden; }

        #app-container { display: flex; height: 100dvh; width: 100vw; position: relative; background: var(--background-color); }

        #sidebar {
            background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100%; z-index: 1000;
            transition: width 0.3s ease, transform 0.3s ease;
            user-select: none; -webkit-user-select: none;
        }
        #sidebar.no-transition { transition: none; }

        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; min-height: 48px; box-sizing: border-box; flex-shrink: 0; }
        .sidebar-header h2 { margin: 0; font-size: 1.1rem; white-space: nowrap; opacity: 1; transition: opacity 0.2s 0.1s ease; }
        .sidebar-action-btn { background: none; border: none; cursor: pointer; color: var(--text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; transition: background-color 0.2s ease, transform 0.3s ease; }
        .sidebar-action-btn:hover { background-color: #e9e9eb; }
        #sidebar-close-btn { display: none; }
        #pin-sidebar-btn { display: none; }

        #chat-history-list { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 0.5rem 0; }
        .chat-history-item { position: relative; display: flex; align-items: center; padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; }
        .chat-history-item .item-icon { margin-right: 1rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: 24px; }
        .chat-title-container { flex-grow: 1; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; opacity: 1; transition: opacity 0.2s 0.1s ease; padding-right: 1rem; }
        .chat-history-item.active { background-color: #e9e9eb; font-weight: 500; }
        
        .rename-input { font: inherit; color: inherit; background-color: #e9e9eb; border-radius: 4px; padding: 0.2rem 0.4rem; width: 100%; box-sizing: border-box; border: 1px solid #ccc; user-select: text; -webkit-user-select: text; }
        .rename-input:focus { border-color: var(--primary-accent); outline: none; }

        .chat-actions-btn { background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; opacity: 0; transition: opacity 0.2s ease; line-height: 1; margin-left: auto; }
        .chat-history-item:hover .chat-actions-btn, .chat-history-item.active .chat-actions-btn { opacity: 1; }
        .chat-actions-btn svg { width: 18px; height: 18px; fill: #555; pointer-events: none; }
        .chat-actions-btn:hover { background-color: #dcdce0; }

        .actions-dropdown-container { position: fixed; display: flex; gap: 0.5rem; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1100; padding: 0.5rem; border: 1px solid var(--border-color); }
        .actions-dropdown-container button { background: none; border: none; border-radius: 6px; padding: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .actions-dropdown-container button:hover { background-color: var(--sidebar-bg); }
        .actions-dropdown-container .delete-action svg { stroke: #d92d20; }

        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        #logout-btn { width: 100%; padding: 0.75rem; background: transparent; border: none; color: var(--text-color); border-radius: 8px; cursor: pointer; font-size: 1rem; display: none; align-items: center; gap: 0.75rem; }
        #logout-btn:hover { background-color: #e9e9eb; }
        #user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        #logout-text { opacity: 1; transition: opacity 0.2s 0.1s ease; }
        body.logged-in #logout-btn { display: flex; }

        #chat-area { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; height: 100%; transition: margin-left 0.3s ease; }
        #sidebar-overlay { display: none; }

        @media (max-width: 767px) {
            #sidebar { width: var(--sidebar-width-expanded); transform: translateX(-100%); }
            body.sidebar-open #sidebar { transform: translateX(0); }
            #sidebar-close-btn { display: flex; }
            #menu-toggle { display: flex; position: fixed; top: 10px; left: 12px; z-index: 101; width: 40px; height: 40px; border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); }
            #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); opacity: 0; z-index: 999; pointer-events: none; transition: opacity 0.3s ease; }
            body.sidebar-open #sidebar-overlay { opacity: 1; pointer-events: auto; }
            #chat-messages { padding: 0.75rem; }
            #chat-input-container { padding: 0.5rem 0.75rem; }
        }
        @media (min-width: 768px) {
            #sidebar { width: var(--sidebar-width-expanded); }
            #chat-area { margin-left: var(--sidebar-width-expanded); }
            #sidebar.is-collapsed { width: var(--sidebar-width-collapsed); }
            #chat-area.sidebar-collapsed { margin-left: var(--sidebar-width-collapsed); }
            #sidebar.is-collapsed .sidebar-header h2,
            #sidebar.is-collapsed .chat-title-container,
            #sidebar.is-collapsed #logout-text,
            #sidebar.is-collapsed .chat-actions-btn { opacity: 0; pointer-events: none; transition-delay: 0s; }
            #sidebar.is-collapsed #pin-sidebar-btn svg { transform: rotate(45deg); }
            #pin-sidebar-btn { display: flex; }
            #menu-toggle { display: none; }
        }

        #chat-header { padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--background-color); z-index: 10; min-height: 48px; position: relative; box-sizing: border-box; }
        #chat-header h1 { font-size: 1.1rem; margin: 0; }
        #chat-messages-container { position: relative; flex-grow: 1; overflow: hidden; }
        #chat-messages { height: 100%; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; max-width: 1024px; margin: 0 auto; box-sizing: border-box; padding-bottom: 30vh; scrollbar-width: none; -ms-overflow-style: none; touch-action: pan-y; }
        #chat-messages::-webkit-scrollbar { display: none; }

        .message-container { max-width: 100%; margin-bottom: 1rem; line-height: 1.7; word-wrap: break-word; }
        .message-container.user { max-width: 85%; padding: 0.75rem 1.1rem; background-color: var(--user-msg-bg); align-self: flex-end; border-radius: 18px; border-bottom-right-radius: 4px; opacity: 0; transform: translateY(15px); animation: fadeInAndRise 0.4s ease forwards; }
        @keyframes fadeInAndRise { to { opacity: 1; transform: translateY(0); } }
        #chat-messages.is-loading-history .message-container { animation: none; opacity: 1; transform: none; }
        .message-container.ai { background-color: transparent; align-self: flex-start; border: none; padding: 0; }
        .ai-content-block > * { opacity: 0; animation: stagedFadeIn 0.6s ease-out forwards; }
        @keyframes stagedFadeIn { to { opacity: 1; } }

        .message-container.ai p:first-child, .ai-content-block p:first-child { margin-top: 0; }
        .message-container.ai p:last-child, .ai-content-block p:last-child { margin-bottom: 0; }

        .welcome-message { align-self: center; text-align: center; margin-top: 2rem; border: none !important; padding: 0 !important; }
        #login-btn { margin-top: 1rem; padding: 0.75rem 1.5rem; background-color: var(--primary-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        
        #chat-input-container { padding: 1rem 1.5rem; background-color: var(--background-color); }
        #chat-form-wrapper { max-width: 1024px; margin: 0 auto; }
        #chat-form { display: flex; align-items: flex-end; gap: 0.75rem; background-color: #fff; border-radius: 24px; padding: 0.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        #chat-input { flex-grow: 1; border: none; background: transparent; padding: 0.6rem 1rem; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; line-height: 1.5; }
        #chat-input:focus { outline: none; }
        #send-btn { background: var(--primary-accent); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .code-block-wrapper { position: relative; margin: 1rem 0; }
        .message-container.ai pre { background-color: var(--code-bg); color: var(--code-text-color); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); overflow-x: auto; font-family: 'SF Mono', 'Fira Code', 'monospace'; font-size: 0.875rem; line-height: 1.6; margin: 0; white-space: pre-wrap; word-break: break-all; }
        .message-container.ai pre code.hljs { padding: 0; background: transparent; }
        .copy-btn { position: absolute; top: 8px; right: 8px; background: #e9e9eb; color: #555; border: 1px solid var(--border-color); padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; opacity: 0; transition: opacity 0.2s ease; }
        .code-block-wrapper:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: #dcdce0; }
        
        .table-wrapper { overflow-x: auto; margin: 1.5rem 0; border: 1px solid var(--border-color); border-radius: 8px; }
        .message-container.ai table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.95rem; }
        .message-container.ai th,
        .message-container.ai td { border-top: 1px solid var(--border-color); padding: 0.75rem 1rem; text-align: left; }
        .message-container.ai tr > th:not(:first-child), .message-container.ai tr > td:not(:first-child) { border-left: 1px solid var(--border-color); }
        .message-container.ai thead th { border-top: none; background-color: var(--sidebar-bg); font-weight: 600; }
        .message-container.ai tbody tr:nth-of-type(even) { background-color: var(--sidebar-bg); }

        .thinking-indicator { display: flex; gap: 4px; align-items: center; padding: 0.75rem 0; }
        .thinking-indicator span { width: 7px; height: 7px; background-color: var(--primary-accent); border-radius: 50%; animation: sleekWave 1.2s ease-in-out infinite; }
        .thinking-indicator span:nth-child(2) { animation-delay: 0.1s; }
        .thinking-indicator span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes sleekWave { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        #scroll-pointers { position: fixed; right: 20px; bottom: 100px; z-index: 100; display: flex; flex-direction: column; gap: 8px; opacity: 0.3; transition: opacity 0.3s ease; pointer-events: none; }
        #chat-area:hover #scroll-pointers { opacity: 0.8; pointer-events: auto; }
        .scroll-btn { width: 36px; height: 36px; background: rgba(0,0,0,0.08); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #333; transition: background-color 0.2s ease; }
        .scroll-btn:hover { background: rgba(0,0,0,0.15); }
        .scroll-btn:active { background: rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="sidebar-overlay"></div>
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>Chat History</h2>
                <div class="sidebar-header-actions">
                    <button id="pin-sidebar-btn" class="sidebar-action-btn" title="Pin Sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    <button id="sidebar-close-btn" class="sidebar-action-btn" title="Close Menu">Ã—</button>
                </div>
            </div>
            <div id="chat-history-list">
                 <div class="chat-history-item" id="new-chat-item">
                    <span class="item-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </span>
                    <div class="chat-title-container">New Chat</div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button id="logout-btn">
                    <img id="user-avatar" src="" alt="User Avatar">
                    <span id="logout-text">Logout</span>
                </button>
            </div>
        </aside>

        <main id="chat-area">
            <header id="chat-header">
                 <button id="menu-toggle" class="sidebar-action-btn" title="Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <h1>AI Chat</h1>
            </header>
            <div id="chat-messages-container">
                <div id="chat-messages"><div class="message-container welcome-message"><p>Welcome! Login to start.</p><button id="login-btn">Login with Google</button></div></div>
            </div>
            <div id="scroll-pointers">
                <button id="scroll-up-btn" class="scroll-btn" title="Scroll Up"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5L12 19M12 5L6 11M12 5L18 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button id="scroll-down-btn" class="scroll-btn" title="Scroll Down"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 19L12 5M12 19L18 13M12 19L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
            <footer id="chat-input-container">
                <div id="chat-form-wrapper">
                    <form id="chat-form"><textarea id="chat-input" placeholder="Message AI..." rows="1" required></textarea><button type="submit" id="send-btn" title="Send Message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></form>
                </div>
            </footer>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyDDdaUMgPSmlkRfjaBDm9SrylWyX7wC2oE",
            authDomain: "ai-chatbot-b38da.firebaseapp.com",
            projectId: "ai-chatbot-b38da",
            databaseURL: "https://ai-chatbot-b38da-default-rtdb.firebaseio.com",
            storageBucket: "ai-chatbot-b38da.firebasestorage.app",
            messagingSenderId: "502343320611",
            appId: "1:502343320611:web:247b096133faf46688dd96"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let currentChatId = null;
        let localChatHistory = [];
        let chatHistoryListener = null;
        let isActionMenuOpen = false;
        let isRenaming = false;

        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chat-area');
        const chatHistoryList = document.getElementById('chat-history-list');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const userAvatar = document.getElementById('user-avatar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        marked.setOptions({
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-', gfm: true, breaks: true,
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.body.classList.add('logged-in');
                userAvatar.src = currentUser.photoURL || '';
                attachChatHistoryListener();
                initializeSidebar();
                initializeScrollButtons();
                startNewChat();
            } else {
                currentUser = null; currentChatId = null; localChatHistory = [];
                document.body.classList.remove('logged-in');
                if (chatHistoryListener) chatHistoryListener.off();
                document.querySelectorAll('.chat-history-item:not(#new-chat-item)').forEach(el => el.remove());
                chatMessages.innerHTML = `<div class="message-container welcome-message"><p>Welcome! Login to start.</p><button id="login-btn">Login with Google</button></div>`;
                document.getElementById('login-btn').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
            }
        });

        function removeActiveDropdown() {
            const existingDropdown = document.querySelector('.actions-dropdown-container');
            if (existingDropdown) existingDropdown.remove();
            isActionMenuOpen = false;
        }

        function handleDeleteChat(chatId) {
            removeActiveDropdown();
            if (!currentUser || !chatId) return;
            if (confirm('Are you sure you want to delete this chat forever?')) {
                db.ref(`chats/${currentUser.uid}/${chatId}`).remove().then(() => {
                    if (chatId === currentChatId) startNewChat();
                }).catch(error => console.error("Error deleting chat:", error));
            }
        }

        function cancelAllRenames() {
            const input = document.querySelector('.rename-input');
            if (input) {
                const titleContainer = input.parentElement;
                titleContainer.textContent = input.dataset.originalTitle;
            }
            isRenaming = false;
        }

        function handleRenameChat(chatId, titleContainer) {
            removeActiveDropdown();
            if (!currentUser || !chatId || isRenaming) return;
            cancelAllRenames();
            
            isRenaming = true;
            const originalTitle = titleContainer.textContent;
            titleContainer.innerHTML = '';

            const input = document.createElement('input');
            input.type = 'text'; input.className = 'rename-input'; input.value = originalTitle;
            input.dataset.originalTitle = originalTitle;

            const saveRename = () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== originalTitle) {
                    db.ref(`chats/${currentUser.uid}/${chatId}`).update({ title: newTitle }).finally(() => {
                        isRenaming = false;
                    });
                } else {
                    titleContainer.textContent = originalTitle;
                    isRenaming = false;
                }
            };
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') { input.value = originalTitle; input.blur(); }
            });
            input.addEventListener('blur', saveRename, { once: true });
            
            titleContainer.appendChild(input);
            input.select();
        }
        
        function attachChatHistoryListener() {
            if (chatHistoryListener) chatHistoryListener.off();
            if (!currentUser) return;
            const chatsRef = db.ref(`chats/${currentUser.uid}`).orderByChild('timestamp');
            chatHistoryListener = chatsRef.on('value', snapshot => {
                if (isRenaming) return;
                
                const chatsData = [];
                snapshot.forEach(child => { chatsData.push({ id: child.key, ...child.val() }); });
                chatsData.reverse();

                const existingItemsMap = new Map();
                chatHistoryList.querySelectorAll('.chat-history-item:not(#new-chat-item)').forEach(el => {
                    existingItemsMap.set(el.dataset.chatId, el);
                });

                chatsData.forEach((chat, index) => {
                    const titleText = chat.title || chat.messages?.[0]?.text.substring(0, 35) || 'New Chat';
                    let itemEl = existingItemsMap.get(chat.id);

                    if (itemEl) {
                        itemEl.querySelector('.chat-title-container').textContent = titleText;
                    } else {
                        itemEl = document.createElement('div');
                        itemEl.className = 'chat-history-item';
                        itemEl.dataset.chatId = chat.id;
                        itemEl.innerHTML = `
                            <span class="item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
                            <div class="chat-title-container">${titleText}</div>
                            <button class="chat-actions-btn" data-chat-id="${chat.id}">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </button>
                        `;
                    }
                    const elementAfter = chatHistoryList.children[index + 1];
                    chatHistoryList.insertBefore(itemEl, elementAfter);
                    existingItemsMap.delete(chat.id);
                });

                existingItemsMap.forEach(el => el.remove());
                updateActiveChatSelection(currentChatId);
            });
        }
        
        async function loadChat(chatId) {
            if (!currentUser || (currentChatId === chatId && chatMessages.children.length > 0)) return;
            if(window.innerWidth < 768) closeSidebar();
            cancelAllRenames();
            const chatRef = db.ref(`chats/${currentUser.uid}/${chatId}`);
            const snapshot = await chatRef.get();
            if (!snapshot.exists()) { startNewChat(); return; }
            
            const chat = snapshot.val();
            localChatHistory = chat.messages || [];
            currentChatId = chatId;
            chatMessages.innerHTML = '';
            chatMessages.classList.add('is-loading-history');

            localChatHistory.forEach(msg => {
                const el = addMessageToUI(msg.role === 'model' ? 'ai' : 'user');
                if(msg.role === 'user') {
                    el.textContent = msg.text;
                } else {
                    el.innerHTML = msg.text;
                    postProcessMessage(el);
                    el.querySelectorAll('.ai-content-block > *').forEach(b => {
                        b.style.opacity = 1;
                        b.style.animation = 'none';
                    });
                }
            });
            
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                chatMessages.classList.remove('is-loading-history');
            });
            updateActiveChatSelection(chatId);
        }

        function startNewChat() {
            if(window.innerWidth < 768) closeSidebar();
            localChatHistory = [];
            chatMessages.innerHTML = '';
            chatInput.value = '';
            chatInput.style.height = 'auto';
            chatInput.focus();
            updateActiveChatSelection(null);
        }
        
        function updateActiveChatSelection(activeId) {
            currentChatId = activeId;
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.classList.toggle('active', item.dataset.chatId === activeId);
            });
            document.getElementById('new-chat-item').classList.toggle('active', activeId === null);
        }

        function addMessageToUI(sender, text = '') {
            const m = document.createElement('div');
            m.className = `message-container ${sender}`;
            if (sender === 'user') { m.textContent = text; }
            chatMessages.appendChild(m);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
            return m;
        }

        function postProcessMessage(container) {
            container.querySelectorAll('pre:not(.code-block-wrapper pre)').forEach(pre => {
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerHTML = `<span>Copy</span>`;
                btn.onclick = () => {
                    navigator.clipboard.writeText(pre.querySelector('code').textContent).then(() => {
                        const span = btn.querySelector('span');
                        if (span) { span.textContent = 'Copied!'; setTimeout(() => { span.textContent = 'Copy'; }, 2000); }
                    });
                };
                wrapper.appendChild(btn);
                hljs.highlightElement(pre.querySelector('code'));
            });
            container.querySelectorAll('table:not(.table-wrapper table)').forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }
        
        function saveChat() {
            if (!currentUser || !currentChatId || localChatHistory.length < 2) return;
            const aiMessageContainer = document.querySelector(`.message-container.ai[data-chat-id="${currentChatId}"]`);
            if (!aiMessageContainer) return;
            const finalContent = aiMessageContainer.innerHTML;
            const lastMessage = localChatHistory[localChatHistory.length - 1];
            if (lastMessage && lastMessage.role === 'model') { lastMessage.text = finalContent; }
            db.ref(`chats/${currentUser.uid}/${currentChatId}`).update({
                messages: localChatHistory,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            if (!currentUser) return;
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessageToUI('user', userMessage);
            localChatHistory.push({ role: 'user', text: userMessage });
            chatInput.value = ''; chatInput.style.height = 'auto';

            if (!currentChatId) {
                const newChatRef = db.ref(`chats/${currentUser.uid}`).push();
                currentChatId = newChatRef.key;
                await newChatRef.set({ title: userMessage.substring(0, 35), messages: localChatHistory, timestamp: firebase.database.ServerValue.TIMESTAMP });
            } else {
                await db.ref(`chats/${currentUser.uid}/${currentChatId}/messages`).set(localChatHistory);
            }

            const aiMsgContainer = addMessageToUI('ai');
            aiMsgContainer.dataset.chatId = currentChatId;
            
            const streamRenderer = {
                container: aiMsgContainer,
                buffer: '',
                state: 'text',
                activeBlock: null,
                activeCodeBlock: null,
                
                createNewBlock() {
                    this.activeBlock = document.createElement('div');
                    this.activeBlock.className = 'ai-content-block';
                    this.container.appendChild(this.activeBlock);
                },

                process(chunk) {
                    this.buffer += chunk;
                    let lastProcessedIndex = 0;

                    if (this.state === 'code') {
                        const endDelimiter = this.buffer.indexOf('```');
                        if (endDelimiter !== -1) {
                            const codeContent = this.buffer.substring(0, endDelimiter);
                            this.activeCodeBlock.textContent += codeContent;
                            this.finalizeBlock();
                            this.buffer = this.buffer.substring(endDelimiter + 3);
                            lastProcessedIndex = 0;
                        } else {
                            this.activeCodeBlock.textContent += this.buffer;
                            this.buffer = '';
                        }
                    }

                    let startDelimiter;
                    while ((startDelimiter = this.buffer.indexOf('```', lastProcessedIndex)) !== -1) {
                        const textBefore = this.buffer.substring(lastProcessedIndex, startDelimiter);
                        this.updateText(textBefore);
                        this.finalizeBlock();

                        const langMatch = this.buffer.substring(startDelimiter + 3).match(/^(\w+)\n/);
                        const lang = langMatch ? langMatch[1] : '';
                        const codeStartsAfter = startDelimiter + 3 + (langMatch ? langMatch[0].length : 0);

                        const endDelimiter = this.buffer.indexOf('```', codeStartsAfter);

                        if (endDelimiter !== -1) {
                            const codeContent = this.buffer.substring(codeStartsAfter, endDelimiter);
                            this.createCodeBlock(codeContent, lang);
                            this.finalizeBlock();
                            lastProcessedIndex = endDelimiter + 3;
                        } else {
                            const codeContent = this.buffer.substring(codeStartsAfter);
                            this.createCodeBlock(codeContent, lang);
                            this.state = 'code';
                            lastProcessedIndex = this.buffer.length;
                            break;
                        }
                    }

                    if (this.state === 'text' && lastProcessedIndex < this.buffer.length) {
                        const remainingText = this.buffer.substring(lastProcessedIndex);
                        this.updateText(remainingText);
                    }
                    this.buffer = this.buffer.substring(lastProcessedIndex);
                },
                
                updateText(text) {
                    if (!text) return;
                    if (!this.activeBlock) this.createNewBlock();
                    this.activeBlock.innerHTML = marked.parse(text);
                },

                createCodeBlock(content, lang) {
                    this.activeBlock = document.createElement('div');
                    this.activeBlock.className = 'ai-content-block';
                    this.container.appendChild(this.activeBlock);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    if (lang) code.className = `language-${lang}`;
                    code.textContent = content;
                    pre.appendChild(code);
                    wrapper.appendChild(pre);
                    this.activeBlock.appendChild(wrapper);
                    this.activeCodeBlock = code;
                },
                
                finalizeBlock() {
                    if (this.activeBlock) {
                        postProcessMessage(this.activeBlock);
                        this.activeBlock.querySelectorAll(':scope > *').forEach((child, index) => {
                            child.style.animationDelay = `${index * 0.05}s`;
                        });
                        this.activeBlock = null;
                        this.activeCodeBlock = null;
                        this.state = 'text';
                    }
                }
            };

            aiMsgContainer.innerHTML = `<div class="ai-content-block"><div class="thinking-indicator"><span></span><span></span><span></span></div></div>`;

            try {
                const response = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: userMessage, history: localChatHistory.slice(0, -1).slice(-10) }) });
                if (!response.ok || !response.body) throw new Error(`API error: ${response.status}`);
                
                aiMsgContainer.innerHTML = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) { streamRenderer.finalizeBlock(); break; }
                    const chunk = decoder.decode(value, { stream: true });
                    streamRenderer.process(chunk);
                    if (chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 150) {
                        chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
                    }
                }
                localChatHistory.push({ role: 'model', text: aiMsgContainer.innerHTML });
                saveChat();

            } catch (error) {
                console.error("Message failed:", error);
                aiMsgContainer.innerHTML = "<div class='ai-content-block'><p>Sorry, an error occurred. Please try again.</p></div>";
                localChatHistory.pop();
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        chatForm.addEventListener('submit', handleSendMessage);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); } });
        chatHistoryList.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-history-item');
            const actionBtn = e.target.closest('.chat-actions-btn');
            
            if (actionBtn) {
                e.stopPropagation();
                removeActiveDropdown();
                const chatId = actionBtn.dataset.chatId;
                const titleContainer = actionBtn.previousElementSibling;
                const rect = actionBtn.getBoundingClientRect();
                
                const dropdown = document.createElement('div');
                dropdown.className = 'actions-dropdown-container';
                dropdown.innerHTML = `
                    <button class="rename-action" title="Rename">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22H15C20 22 22 20 22 15V13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.04 3.02001L8.16 10.9C7.86 11.2 7.56 11.79 7.5 12.22L7.07 15.23C6.91 16.32 7.68 17.08 8.77 16.93L11.78 16.5C12.2 16.44 12.79 16.14 13.1 15.84L20.98 7.96001C22.34 6.60001 22.98 5.01001 20.98 3.01001C18.98 1.01001 17.39 1.66001 16.04 3.02001Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                    <button class="delete-action" title="Delete">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 5.97998C17.67 5.64998 14.32 5.47998 10.98 5.47998C9 5.47998 7.02 5.57998 5.04 5.77998L3 5.97998" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 4.97L8.72 3.66C8.88 2.71 9 2 10.69 2H13.31C15 2 15.12 2.75 15.28 3.67L15.5 4.97" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.85 9.14001L18.2 19.21C18.09 20.78 18 22 15.21 22H8.79C6 22 5.91 20.78 5.8 19.21L5.15 9.14001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.33 16.5H13.66" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 12.5H14.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                `;
                document.body.appendChild(dropdown);
                isActionMenuOpen = true;
                
                dropdown.style.left = `${rect.left - dropdown.offsetWidth + rect.width}px`;
                dropdown.style.top = `${rect.bottom + 4}px`;

                dropdown.querySelector('.rename-action').addEventListener('click', () => handleRenameChat(chatId, titleContainer));
                dropdown.querySelector('.delete-action').addEventListener('click', () => handleDeleteChat(chatId));

            } else if (item) {
                if (item.id === 'new-chat-item') startNewChat();
                else if (item.dataset.chatId) loadChat(item.dataset.chatId);
            }
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.actions-dropdown-container') && !e.target.closest('.chat-actions-btn')) removeActiveDropdown();
            if (!e.target.closest('.rename-input')) cancelAllRenames();
        });
        
        const openSidebar = () => { document.body.classList.add('sidebar-open'); sidebar.style.transform = ''; sidebarOverlay.style.opacity = ''; };
        const closeSidebar = () => { document.body.classList.remove('sidebar-open'); sidebar.style.transform = ''; sidebarOverlay.style.opacity = ''; };
        
        function initializeSidebar() {
            const pinBtn = document.getElementById('pin-sidebar-btn');
            const menuToggleBtn = document.getElementById('menu-toggle');
            const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
            
            const setPinnedState = (isPinned) => {
                localStorage.setItem('sidebarPinned', isPinned);
                sidebar.classList.toggle('is-pinned', isPinned);
                pinBtn.title = isPinned ? 'Unpin Sidebar' : 'Pin Sidebar';
            };
            
            if (window.innerWidth >= 768) {
                const isPinned = localStorage.getItem('sidebarPinned') === 'true';
                setPinnedState(isPinned);
                if (!isPinned) {
                    sidebar.classList.add('is-collapsed');
                    chatArea.classList.add('sidebar-collapsed');
                }
                sidebar.addEventListener('mouseenter', () => { sidebar.classList.remove('is-collapsed'); chatArea.classList.remove('sidebar-collapsed'); });
                sidebar.addEventListener('mouseleave', () => {
                    if (isActionMenuOpen || sidebar.classList.contains('is-pinned')) return;
                    sidebar.classList.add('is-collapsed'); chatArea.classList.add('sidebar-collapsed');
                });
                pinBtn.addEventListener('click', (e) => { e.stopPropagation(); setPinnedState(!sidebar.classList.contains('is-pinned')); });
            } else {
                menuToggleBtn.addEventListener('click', openSidebar);
                sidebarCloseBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);
            }
        }
        
        let isDragging = false, startX = 0, startY = 0, currentTranslate = 0, dragDirection = null;
        const dragStart = (e) => {
            if (window.innerWidth >= 768) return;
            const t = e.type === 'touchstart' ? e.touches : e;
            const isOpen = document.body.classList.contains('sidebar-open');
            if (!isOpen && t.clientX > 50) return;

            isDragging = true; startX = t.clientX; startY = t.clientY; dragDirection = null;
            sidebar.classList.add('no-transition');
            currentTranslate = isOpen ? 0 : -sidebar.offsetWidth;
        };
        const dragMove = (e) => {
            if (!isDragging) return;
            const t = e.type === 'touchmove' ? e.touches : e;
            const deltaX = t.clientX - startX; const deltaY = t.clientY - startY;
            if (dragDirection === null) {
                if (Math.abs(deltaX) > Math.abs(deltaY) + 3) {
                     dragDirection = 'horizontal'; document.body.classList.add('is-dragging');
                } else {
                     dragDirection = 'vertical';
                }
            }
            if (dragDirection === 'horizontal') {
                e.preventDefault();
                const newTranslate = currentTranslate + deltaX;
                const s = Math.min(0, Math.max(-sidebar.offsetWidth, newTranslate));
                sidebar.style.transform = `translateX(${s}px)`;
                sidebarOverlay.style.opacity = 1 - (Math.abs(s) / sidebar.offsetWidth);
            }
        };
        const dragEnd = () => {
            if (!isDragging || dragDirection !== 'horizontal') {
                isDragging = false; dragDirection = null; return;
            }
            isDragging = false; dragDirection = null;
            sidebar.classList.remove('no-transition');
            document.body.classList.remove('is-dragging');
            const t = new DOMMatrix(getComputedStyle(sidebar).transform).m41;
            t > -sidebar.offsetWidth / 2 ? openSidebar() : closeSidebar();
        };
        document.body.addEventListener('mousedown', dragStart); document.body.addEventListener('mousemove', dragMove); document.body.addEventListener('mouseup', dragEnd); document.body.addEventListener('mouseleave', dragEnd);
        document.body.addEventListener('touchstart', dragStart, { passive: false }); document.body.addEventListener('touchmove', dragMove, { passive: false }); document.body.addEventListener('touchend', dragEnd);

        function initializeScrollButtons() {
            const scrollUpBtn = document.getElementById('scroll-up-btn');
            const scrollDownBtn = document.getElementById('scroll-down-btn');
            let isScrolling = false; let scrollId;
            
            const scrollLoop = (direction) => {
                chatMessages.scrollTop += direction * 8;
                scrollId = requestAnimationFrame(() => scrollLoop(direction));
            };
            const startScroll = (direction) => {
                if (isScrolling) return;
                isScrolling = true;
                scrollLoop(direction);
            };
            const stopScroll = () => {
                isScrolling = false; 
                cancelAnimationFrame(scrollId);
            };
            
            scrollUpBtn.addEventListener('mousedown', () => startScroll(-1));
            scrollDownBtn.addEventListener('mousedown', () => startScroll(1));
            scrollUpBtn.addEventListener('dblclick', () => chatMessages.scrollTo({ top: 0, behavior: 'smooth' }));
            scrollDownBtn.addEventListener('dblclick', () => chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' }));
            
            document.body.addEventListener('mouseup', stopScroll);
            document.body.addEventListener('mouseleave', stopScroll);
            
            scrollUpBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startScroll(-1); }, { passive: false });
            scrollDownBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startScroll(1); }, { passive: false });
            document.body.addEventListener('touchend', (e) => { if(isScrolling) stopScroll(); });
        }
    });
    </script>
</body>
</html>
